import type { WalletClient } from 'viem';

import { IS_MAINNET } from '@good/data/constants';
import { VerifiedOpenActionModules } from '@good/data/verified-openaction-modules';
import { polygon, polygonAmoy } from 'viem/chains';
import { describe, expect, it, vi } from 'vitest';

import {
    constructPermit2Sig,
    getPermit2Allowance,
    permit2SignatureAmount,
    signPermitSignature,
    updateWrapperParams
} from './permit2';

describe('permit2SignatureAmount', () => {
  it('returns the correct amount for non-polygon chains', () => {
    // from https://rarible.com/token/0xb66a603f4cfe17e3d27b87a8bfcad319856518b8:76925175832665333250355428716222482481488866752663408494164754717630693113858?tab=overview
    const data =
      '0x000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000c400000000000000000000000000000000000000000000000000000000000000d40000000000000000000000000354cd122a1b3ebf102306f6bccccf8abebaff7080000000000000000000000000d500b1d8e8ef31e21c99d1db9a6444d3adf1270000000000000000000000000000000000000000000000003486023194fef0102000000000000000000000000000000000000000000000003205b8f2338fa03960000000000000000000000000000000000000000000000000000000113268fa800000000000000000000000000000000000000000000000310aa13dc41e60d8f0000000000000000000000000000000000000000000000000000000066330fe30000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000001600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001200000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000009757f2d2b135150bbeb65308d4a91804107cd8d60000000000000000000000009757f2d2b135150bbeb65308d4a91804107cd8d6000000000000000000000000354cd122a1b3ebf102306f6bccccf8abebaff70800000000000000000000000000000000000000000000000000000000000004a00000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001800000000000000000000000000000000000000000000000000000000000000060000000000000000000000000777e05d02ea7b42f32f103c089c175017082f531000000000000000000000000354cd122a1b3ebf102306f6bccccf8abebaff7080000000000000000000000000000000000000000000000000000000113268fa80000000000000000000000000000000000000000000000000000000000103d3a0000000000000000000000000d500b1d8e8ef31e21c99d1db9a6444d3adf12700000000000000000000000007ceb23fd6bc0add59e62ac25578270cff1b9f619000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000002b7ceb23fd6bc0add59e62ac25578270cff1b9f6190001f40d500b1d8e8ef31e21c99d1db9a6444d3adf127000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000000600000000000000000000000001572d48a52906b834fb236aa77831d669f6d87a1000000000000000000000000354cd122a1b3ebf102306f6bccccf8abebaff7080000000000000000000000000000000000000000000000000000000000103d3a0000000000000000000000000000000000000000000000000000000000103d3a000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005240d5f7d350000000000000000000000000000000000000000000000000000000000000020000000000000000000000000aa121b49698ee02b1d49f193b5b1e1fa3c2062f60000000000000000000000000000000000000000000000000000000000000001973bb6400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001e000000000000000000000000000000000000000000000000000000000000f1b300000000000000000000000000000000000000000000000000000000000000000e1931b4d16be73480310945ad5cb93b2d4f38037f6377fae33778fa4ad05346a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000023d235ef000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000240000000000000000000000000000000000000000000000000000000000000036000000000000000000000000000000000000000000000000000000000000f1b30000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000003e00000000000000000000000000000000000000000000000000000000000000040000000000000000000000000b66a603f4cfe17e3d27b87a8bfcad319856518b8aa121b49698ee02b1d49f193b5b1e1fa3c2062f600000000000000000000000200000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000001cf0df2a5a20cd61d68d4489eebbf85b8d39e18a00000000000000000000000000000000000000000000000000000000000000fa00000000000000000000000000000000000000000000000000000000000000419495f61c2d804fcb3222d3bd8e20990cc3689286dfc0367dad0f3f18cee1321d79989a51f33e6a0156ad9189b46c72b63f4bb7b1192b8dfe496b9b9fb003de6f1c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000001cf0df2a5a20cd61d68d4489eebbf85b8d39e18a00000000000000000000000000000000000000000000000000000000000000fa00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000001e84809958e2490000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000030742ea75e5de0a4a00000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000001000000000000000000000000accc1fe6537eb8eb56b31ccfc48eb9363e8dd32e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096729665c08034500000000000000000000000000000000000000000000000000000000000000410d6376e175a47926d937e9fff0b6d56f4625cfd4da8ff65f6f8a90ae06a5fcd7734830d1819a880d042c3a099d4b0f3c5fbca2ac5f697e87865616f8391ef56f1c00000000000000000000000000000000000000000000000000000000000000';
    const amount = permit2SignatureAmount({ chainId: 1, data });
    expect(amount).toBe(60555439181245907202n); // Assuming the mock returns 0
  });

  it('returns the correct amount for polygon chain', () => {
    // from https://rarible.com/token/polygon/0x44b3f42e2bf34f62868ff9e9dab7c2f807ba97cb:165
    const data =
      '0x0000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000009a00000000000000000000000000000000000000000000000000000000000000aa0000000000000000000000000354cd122a1b3ebf102306f6bccccf8abebaff7080000000000000000000000000d500b1d8e8ef31e21c99d1db9a6444d3adf12700000000000000000000000000000000000000000000000000a3a2be48677be0f00000000000000000000000000000000000000000000000009974e115ddf3688000000000000000000000000000000000000000000000000002631116b55e000000000000000000000000000000000000000000000000000096729665c0803450000000000000000000000000000000000000000000000000000000066330f9a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000001600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000012b3897a36fdb436dde2788c06eff0ffd997066e00000000000000000000000012b3897a36fdb436dde2788c06eff0ffd997066e000000000000000000000000354cd122a1b3ebf102306f6bccccf8abebaff70800000000000000000000000000000000000000000000000000000000000002400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001400000000000000000000000000000000000000000000000000000000000000060000000000000000000000000777e05d02ea7b42f32f103c089c175017082f531000000000000000000000000354cd122a1b3ebf102306f6bccccf8abebaff708000000000000000000000000000000000000000000000000002631116b55e000000000000000000000000000000000000000000000000000002631116b55e0000000000000000000000000000d500b1d8e8ef31e21c99d1db9a6444d3adf12700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005240d5f7d350000000000000000000000000000000000000000000000000000000000000020000000000000000000000000241bd5a8f26f751e4763ae1be747a0361caf85120000000000000000000000000000000000000000000000000000000000000001973bb6400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001e0000000000000000000000000000000000000000000000000002386f26fc1000000000000000000000000000000000000000000000000000000000000000000008bd55046e20d9379b96e8ccb30ae53f8d919bcffd79195e55e1134652643e7f40000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006645cae523d235ef0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002400000000000000000000000000000000000000000000000000000000000000360000000000000000000000000000000000000000000000000002386f26fc10000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000003e0000000000000000000000000000000000000000000000000000000000000004000000000000000000000000044b3f42e2bf34f62868ff9e9dab7c2f807ba97cb00000000000000000000000000000000000000000000000000000000000000a500000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000f22f838aaca272afb0f268e4f4e655fac3a35ec00000000000000000000000000000000000000000000000000000000000002ee00000000000000000000000000000000000000000000000000000000000000414e3262b236cf9c3acb76bb26aa06222b9e8ed09b6311cb26172db39d43f88a846b6034ac0f973ef7976ec0e1d12a7e1d3b738a5e6bd8d44e67106f8ab7b848e51b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000f22f838aaca272afb0f268e4f4e655fac3a35ec00000000000000000000000000000000000000000000000000000000000002ee000000000000000000000000000000000000000000000000000000009958e249000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000001000000000000000000000000accc1fe6537eb8eb56b31ccfc48eb9363e8dd32e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096729665c08034500000000000000000000000000000000000000000000000000000000000000413725120ac3b82ec7778c98275483b7944c520e3ee15b6e70993c4953b1da2580178dc272ed2a47ca27aad9f10b83c9e08a039522ff6b57ab79ba0566f12196c81c00000000000000000000000000000000000000000000000000000000000000';
    const amount = permit2SignatureAmount({ chainId: 137, data });
    expect(amount).toBe(736949749537029647n); // Assuming the mock returns 0
  });
});

describe('updateWrapperParams', () => {
  it('updates parameters correctly for non-polygon chains', () => {
    // from https://rarible.com/token/0xb66a603f4cfe17e3d27b87a8bfcad319856518b8:76925175832665333250355428716222482481488866752663408494164754717630693113858?tab=overview
    const data =
      '0x000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000c400000000000000000000000000000000000000000000000000000000000000d40000000000000000000000000354cd122a1b3ebf102306f6bccccf8abebaff7080000000000000000000000000d500b1d8e8ef31e21c99d1db9a6444d3adf1270000000000000000000000000000000000000000000000003486023194fef0102000000000000000000000000000000000000000000000003205b8f2338fa03960000000000000000000000000000000000000000000000000000000113268fa800000000000000000000000000000000000000000000000310aa13dc41e60d8f0000000000000000000000000000000000000000000000000000000066330fe30000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000001600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001200000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000009757f2d2b135150bbeb65308d4a91804107cd8d60000000000000000000000009757f2d2b135150bbeb65308d4a91804107cd8d6000000000000000000000000354cd122a1b3ebf102306f6bccccf8abebaff70800000000000000000000000000000000000000000000000000000000000004a00000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001800000000000000000000000000000000000000000000000000000000000000060000000000000000000000000777e05d02ea7b42f32f103c089c175017082f531000000000000000000000000354cd122a1b3ebf102306f6bccccf8abebaff7080000000000000000000000000000000000000000000000000000000113268fa80000000000000000000000000000000000000000000000000000000000103d3a0000000000000000000000000d500b1d8e8ef31e21c99d1db9a6444d3adf12700000000000000000000000007ceb23fd6bc0add59e62ac25578270cff1b9f619000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000002b7ceb23fd6bc0add59e62ac25578270cff1b9f6190001f40d500b1d8e8ef31e21c99d1db9a6444d3adf127000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000000600000000000000000000000001572d48a52906b834fb236aa77831d669f6d87a1000000000000000000000000354cd122a1b3ebf102306f6bccccf8abebaff7080000000000000000000000000000000000000000000000000000000000103d3a0000000000000000000000000000000000000000000000000000000000103d3a000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005240d5f7d350000000000000000000000000000000000000000000000000000000000000020000000000000000000000000aa121b49698ee02b1d49f193b5b1e1fa3c2062f60000000000000000000000000000000000000000000000000000000000000001973bb6400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001e000000000000000000000000000000000000000000000000000000000000f1b300000000000000000000000000000000000000000000000000000000000000000e1931b4d16be73480310945ad5cb93b2d4f38037f6377fae33778fa4ad05346a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000023d235ef000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000240000000000000000000000000000000000000000000000000000000000000036000000000000000000000000000000000000000000000000000000000000f1b30000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000003e00000000000000000000000000000000000000000000000000000000000000040000000000000000000000000b66a603f4cfe17e3d27b87a8bfcad319856518b8aa121b49698ee02b1d49f193b5b1e1fa3c2062f600000000000000000000000200000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000001cf0df2a5a20cd61d68d4489eebbf85b8d39e18a00000000000000000000000000000000000000000000000000000000000000fa00000000000000000000000000000000000000000000000000000000000000419495f61c2d804fcb3222d3bd8e20990cc3689286dfc0367dad0f3f18cee1321d79989a51f33e6a0156ad9189b46c72b63f4bb7b1192b8dfe496b9b9fb003de6f1c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000001cf0df2a5a20cd61d68d4489eebbf85b8d39e18a00000000000000000000000000000000000000000000000000000000000000fa00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000001e84809958e2490000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000030742ea75e5de0a4a00000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000001000000000000000000000000accc1fe6537eb8eb56b31ccfc48eb9363e8dd32e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096729665c08034500000000000000000000000000000000000000000000000000000000000000410d6376e175a47926d937e9fff0b6d56f4625cfd4da8ff65f6f8a90ae06a5fcd7734830d1819a880d042c3a099d4b0f3c5fbca2ac5f697e87865616f8391ef56f1c00000000000000000000000000000000000000000000000000000000000000';
    const updatedData = updateWrapperParams({
      chainId: 123,
      data,
      deadline: BigInt(0),
      nonce: BigInt(0),
      signature: '0x'
    });
    expect(updatedData).toBe(
      '0x000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000c400000000000000000000000000000000000000000000000000000000000000d40000000000000000000000000354cd122a1b3ebf102306f6bccccf8abebaff7080000000000000000000000000d500b1d8e8ef31e21c99d1db9a6444d3adf1270000000000000000000000000000000000000000000000003486023194fef0102000000000000000000000000000000000000000000000003205b8f2338fa03960000000000000000000000000000000000000000000000000000000113268fa800000000000000000000000000000000000000000000000310aa13dc41e60d8f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000001600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001200000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000009757f2d2b135150bbeb65308d4a91804107cd8d60000000000000000000000009757f2d2b135150bbeb65308d4a91804107cd8d6000000000000000000000000354cd122a1b3ebf102306f6bccccf8abebaff70800000000000000000000000000000000000000000000000000000000000004a00000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001800000000000000000000000000000000000000000000000000000000000000060000000000000000000000000777e05d02ea7b42f32f103c089c175017082f531000000000000000000000000354cd122a1b3ebf102306f6bccccf8abebaff7080000000000000000000000000000000000000000000000000000000113268fa80000000000000000000000000000000000000000000000000000000000103d3a0000000000000000000000000d500b1d8e8ef31e21c99d1db9a6444d3adf12700000000000000000000000007ceb23fd6bc0add59e62ac25578270cff1b9f619000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000002b7ceb23fd6bc0add59e62ac25578270cff1b9f6190001f40d500b1d8e8ef31e21c99d1db9a6444d3adf127000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000000600000000000000000000000001572d48a52906b834fb236aa77831d669f6d87a1000000000000000000000000354cd122a1b3ebf102306f6bccccf8abebaff7080000000000000000000000000000000000000000000000000000000000103d3a0000000000000000000000000000000000000000000000000000000000103d3a000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005240d5f7d350000000000000000000000000000000000000000000000000000000000000020000000000000000000000000aa121b49698ee02b1d49f193b5b1e1fa3c2062f60000000000000000000000000000000000000000000000000000000000000001973bb6400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001e000000000000000000000000000000000000000000000000000000000000f1b300000000000000000000000000000000000000000000000000000000000000000e1931b4d16be73480310945ad5cb93b2d4f38037f6377fae33778fa4ad05346a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000023d235ef000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000240000000000000000000000000000000000000000000000000000000000000036000000000000000000000000000000000000000000000000000000000000f1b30000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000003e00000000000000000000000000000000000000000000000000000000000000040000000000000000000000000b66a603f4cfe17e3d27b87a8bfcad319856518b8aa121b49698ee02b1d49f193b5b1e1fa3c2062f600000000000000000000000200000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000001cf0df2a5a20cd61d68d4489eebbf85b8d39e18a00000000000000000000000000000000000000000000000000000000000000fa00000000000000000000000000000000000000000000000000000000000000419495f61c2d804fcb3222d3bd8e20990cc3689286dfc0367dad0f3f18cee1321d79989a51f33e6a0156ad9189b46c72b63f4bb7b1192b8dfe496b9b9fb003de6f1c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000001cf0df2a5a20cd61d68d4489eebbf85b8d39e18a00000000000000000000000000000000000000000000000000000000000000fa00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000001e84809958e2490000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000030742ea75e5de0a4a00000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000001000000000000000000000000accc1fe6537eb8eb56b31ccfc48eb9363e8dd32e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096729665c08034500000000000000000000000000000000000000000000000000000000000000410d6376e175a47926d937e9fff0b6d56f4625cfd4da8ff65f6f8a90ae06a5fcd7734830d1819a880d042c3a099d4b0f3c5fbca2ac5f697e87865616f8391ef56f1c00000000000000000000000000000000000000000000000000000000000000'
    );
  });

  it('updates parameters correctly for polygon chain', () => {
    // from https://rarible.com/token/polygon/0x44b3f42e2bf34f62868ff9e9dab7c2f807ba97cb:165
    const data =
      '0x0000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000009a00000000000000000000000000000000000000000000000000000000000000aa0000000000000000000000000354cd122a1b3ebf102306f6bccccf8abebaff7080000000000000000000000000d500b1d8e8ef31e21c99d1db9a6444d3adf12700000000000000000000000000000000000000000000000000a3a2be48677be0f00000000000000000000000000000000000000000000000009974e115ddf3688000000000000000000000000000000000000000000000000002631116b55e000000000000000000000000000000000000000000000000000096729665c0803450000000000000000000000000000000000000000000000000000000066330f9a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000001600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000012b3897a36fdb436dde2788c06eff0ffd997066e00000000000000000000000012b3897a36fdb436dde2788c06eff0ffd997066e000000000000000000000000354cd122a1b3ebf102306f6bccccf8abebaff70800000000000000000000000000000000000000000000000000000000000002400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001400000000000000000000000000000000000000000000000000000000000000060000000000000000000000000777e05d02ea7b42f32f103c089c175017082f531000000000000000000000000354cd122a1b3ebf102306f6bccccf8abebaff708000000000000000000000000000000000000000000000000002631116b55e000000000000000000000000000000000000000000000000000002631116b55e0000000000000000000000000000d500b1d8e8ef31e21c99d1db9a6444d3adf12700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005240d5f7d350000000000000000000000000000000000000000000000000000000000000020000000000000000000000000241bd5a8f26f751e4763ae1be747a0361caf85120000000000000000000000000000000000000000000000000000000000000001973bb6400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001e0000000000000000000000000000000000000000000000000002386f26fc1000000000000000000000000000000000000000000000000000000000000000000008bd55046e20d9379b96e8ccb30ae53f8d919bcffd79195e55e1134652643e7f40000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006645cae523d235ef0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002400000000000000000000000000000000000000000000000000000000000000360000000000000000000000000000000000000000000000000002386f26fc10000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000003e0000000000000000000000000000000000000000000000000000000000000004000000000000000000000000044b3f42e2bf34f62868ff9e9dab7c2f807ba97cb00000000000000000000000000000000000000000000000000000000000000a500000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000f22f838aaca272afb0f268e4f4e655fac3a35ec00000000000000000000000000000000000000000000000000000000000002ee00000000000000000000000000000000000000000000000000000000000000414e3262b236cf9c3acb76bb26aa06222b9e8ed09b6311cb26172db39d43f88a846b6034ac0f973ef7976ec0e1d12a7e1d3b738a5e6bd8d44e67106f8ab7b848e51b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000f22f838aaca272afb0f268e4f4e655fac3a35ec00000000000000000000000000000000000000000000000000000000000002ee000000000000000000000000000000000000000000000000000000009958e249000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000001000000000000000000000000accc1fe6537eb8eb56b31ccfc48eb9363e8dd32e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096729665c08034500000000000000000000000000000000000000000000000000000000000000413725120ac3b82ec7778c98275483b7944c520e3ee15b6e70993c4953b1da2580178dc272ed2a47ca27aad9f10b83c9e08a039522ff6b57ab79ba0566f12196c81c00000000000000000000000000000000000000000000000000000000000000';
    const updatedData = updateWrapperParams({
      chainId: 137,
      data,
      deadline: BigInt(0),
      nonce: BigInt(0),
      signature: '0x'
    });
    expect(updatedData).toBe(
      '0x0000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000009a00000000000000000000000000000000000000000000000000000000000000aa0000000000000000000000000354cd122a1b3ebf102306f6bccccf8abebaff7080000000000000000000000000d500b1d8e8ef31e21c99d1db9a6444d3adf12700000000000000000000000000000000000000000000000000a3a2be48677be0f00000000000000000000000000000000000000000000000009974e115ddf3688000000000000000000000000000000000000000000000000002631116b55e000000000000000000000000000000000000000000000000000096729665c08034500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000001600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000012b3897a36fdb436dde2788c06eff0ffd997066e00000000000000000000000012b3897a36fdb436dde2788c06eff0ffd997066e000000000000000000000000354cd122a1b3ebf102306f6bccccf8abebaff70800000000000000000000000000000000000000000000000000000000000002400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001400000000000000000000000000000000000000000000000000000000000000060000000000000000000000000777e05d02ea7b42f32f103c089c175017082f531000000000000000000000000354cd122a1b3ebf102306f6bccccf8abebaff708000000000000000000000000000000000000000000000000002631116b55e000000000000000000000000000000000000000000000000000002631116b55e0000000000000000000000000000d500b1d8e8ef31e21c99d1db9a6444d3adf12700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005240d5f7d350000000000000000000000000000000000000000000000000000000000000020000000000000000000000000241bd5a8f26f751e4763ae1be747a0361caf85120000000000000000000000000000000000000000000000000000000000000001973bb6400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001e0000000000000000000000000000000000000000000000000002386f26fc1000000000000000000000000000000000000000000000000000000000000000000008bd55046e20d9379b96e8ccb30ae53f8d919bcffd79195e55e1134652643e7f40000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006645cae523d235ef0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002400000000000000000000000000000000000000000000000000000000000000360000000000000000000000000000000000000000000000000002386f26fc10000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000003e0000000000000000000000000000000000000000000000000000000000000004000000000000000000000000044b3f42e2bf34f62868ff9e9dab7c2f807ba97cb00000000000000000000000000000000000000000000000000000000000000a500000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000f22f838aaca272afb0f268e4f4e655fac3a35ec00000000000000000000000000000000000000000000000000000000000002ee00000000000000000000000000000000000000000000000000000000000000414e3262b236cf9c3acb76bb26aa06222b9e8ed09b6311cb26172db39d43f88a846b6034ac0f973ef7976ec0e1d12a7e1d3b738a5e6bd8d44e67106f8ab7b848e51b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000f22f838aaca272afb0f268e4f4e655fac3a35ec00000000000000000000000000000000000000000000000000000000000002ee000000000000000000000000000000000000000000000000000000009958e249000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000001000000000000000000000000accc1fe6537eb8eb56b31ccfc48eb9363e8dd32e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096729665c08034500000000000000000000000000000000000000000000000000000000000000413725120ac3b82ec7778c98275483b7944c520e3ee15b6e70993c4953b1da2580178dc272ed2a47ca27aad9f10b83c9e08a039522ff6b57ab79ba0566f12196c81c00000000000000000000000000000000000000000000000000000000000000'
    );
  });
});

describe('getPermit2Allowance', () => {
  it('retrieves allowance data', async () => {
    const allowance = await getPermit2Allowance({
      owner: '0xF74360278e181FdCFdfA694687cF53FC163dEe18',
      spender: '0x000000000022D473030F116dDEE9F6B43aC78BA3',
      token: '0x0d500B1d8E8eF31E21C99d1Db9A6444d3ADf1270'
    });
    expect(allowance).toBeGreaterThan(
      BigInt(578960446186580977117854925043439539266349923n)
    );
  });
});

describe('constructPermit2Sig', () => {
  it('constructs signature data correctly', () => {
    const sigData = constructPermit2Sig({
      amount: BigInt(100),
      token: '0x0d500B1d8E8eF31E21C99d1Db9A6444d3ADf1270'
    });
    expect(sigData.domain).toEqual({
      chainId: IS_MAINNET ? polygon.id : polygonAmoy.id,
      name: 'Permit2',
      verifyingContract: '0x000000000022D473030F116dDEE9F6B43aC78BA3'
    });
    expect(sigData.types).toEqual({
      PermitTransferFrom: [
        {
          name: 'permitted',
          type: 'TokenPermissions'
        },
        {
          name: 'spender',
          type: 'address'
        },
        {
          name: 'nonce',
          type: 'uint256'
        },
        {
          name: 'deadline',
          type: 'uint256'
        }
      ],
      TokenPermissions: [
        {
          name: 'token',
          type: 'address'
        },
        {
          name: 'amount',
          type: 'uint256'
        }
      ]
    });
    expect(sigData.values.permitted).toEqual({
      amount: 100n,
      token: '0x0d500B1d8E8eF31E21C99d1Db9A6444d3ADf1270'
    });
    expect(sigData.values.spender).toEqual(VerifiedOpenActionModules.DecentNFT);
  });
});

describe('signPermitSignature', () => {
  it('signs data correctly using the wallet client', async () => {
    const walletClient = {
      account: '0x0',
      signTypedData: vi.fn().mockResolvedValue('signature')
    } as unknown as WalletClient;
    const signature = await signPermitSignature(
      walletClient,
      BigInt(100),
      '0x1'
    );
    expect(signature).toHaveProperty('signature');
  });

  it('throws an error when wallet client has no account attached', async () => {
    const walletClient = {
      signTypedData: vi.fn().mockResolvedValue('signature')
    } as unknown as WalletClient;
    const callWithoutClient = signPermitSignature(
      walletClient,
      BigInt(100),
      '0x1'
    );
    await expect(callWithoutClient).rejects.toThrow(
      'no account attached to wallet client'
    );
  });
});
